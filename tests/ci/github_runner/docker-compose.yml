# Please refer to `README.md` for how to setup this GitHub action runner
version: "3.9"

services:
  runner:
    image: ghcr.io/actions/actions-runner:2.328.0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /data/miles_ci:/data/miles_ci
      # it requires this folder
      - /home/runner/externals:/home/runner/externals
    deploy:
      replicas: 8
    restart: always
    environment:
      RUNNER_ALLOW_RUNASROOT: "1"
    privileged: true
    user: root
    # ref: https://github.com/actions/runner/issues/367#issuecomment-2007558723
    # ref: https://github.com/actions/runner
    # args ref: https://github.com/actions/runner/blob/68ff57dbc4c836d50f46602a8a53301fb9513eb4/src/Runner.Listener/CommandSettings.cs#L53
    entrypoint: >
      sh -c '
        set -e

        DIR="/data/miles_ci/runner_$(hostname)"
        FLAG="$DIR/miles_runner_config_executed.txt"

        mkdir -p "$DIR"

        if [ ! -f "$FLAG" ]; then
          /home/runner/config.sh --url ${GITHUB_RUNNER_URL} --token ${GITHUB_RUNNER_TOKEN} --unattended --work "$DIR"
          echo "configured" > "$FLAG"
        else
          echo "config.sh already executed, skipping"
        fi

        exec /home/runner/run.sh
      '
